---
# =====================================================================
# tasks file for ansible-role-compliance-windows-system-policy-2019
# =====================================================================
#
#
# ==================================================================
# collect hostname and ip address information
# ==================================================================
- name: collect hostname
  win_shell: >
    $sysinfo=Get-WmiObject -Class win32_computersystem;
    $server="{0}.{1}" -f $sysinfo.Name, $sysinfo.domain;
    $server
  register: FQDN_hostname
  ignore_errors: true

- name: set output
  set_fact:
   FQDN_hostname: "{{ FQDN_hostname.stdout_lines | join }}"

- block:
   - debug:
      msg:
       - "The FQDN hostname is.....{{ FQDN_hostname }}"

- name: collect ip address
  win_shell: >
     (Get-NetIPConfiguration | Where-Object { $_.IPv4DefaultGateway -ne
     $null -and $_.netadapter.status -ne "Disconnected"}).ipv4address.ipaddress
  register: default_ipv4_address
  ignore_errors: true

- name: set output
  set_fact:
   default_ipv4_address: "{{ default_ipv4_address.stdout_lines }}"

- block:
   - debug:
      msg:
       - "The default_ipv4_address is.....{{ default_ipv4_address }}"


# ==================================================================
# Get O\S information
# ==================================================================
- name: "Get Operating Systerm version information"
  win_shell: (get-WMIobject win32_operatingsystem).Name
  register: Win_os_ver_out
  ignore_errors: true

- name: "set output variable"
  set_fact:
   Win_os_ver_out="{{ Win_os_ver_out.stdout_lines|list|join }}"

- name: "check and ensure if the windows server is a 2019 server"
  fail:
   msg: "This server is NOT a windows 2019 server: {{ Win_os_ver_out }}"
  when: approved_windows_ver not in Win_os_ver_out

- block:
   - debug:
      msg:
       - "This server IS a windows 2019 server: {{ Win_os_ver_out }}"
  when: approved_windows_ver in Win_os_ver_out
#
#
# ==================================================================
# Get server role information
# ==================================================================
- name: "Get server role information"
  win_shell: wmic.exe Computersystem get DomainRole
  register: DomainR_out
  ignore_errors: true

- name: "set output variable"
  set_fact:
   DomainR_out: "{{ DomainR_out.stdout|regex_search(regexp,'\\1')|list|join }}"
  vars:
   regexp: 'DomainRole\s+(\d+)'

- block:
   - debug:
      msg:
       - "The DomainRole is NOT a Backup DC or a DC: '{{ DomainR_out }}'."
  when: DomainR_out != "4" and DomainR_out != "5"

- block:
   - debug:
      msg:
       - "The DomainRole is a Backup DC or a DC:'{{ DomainR_out }}'."
  when: DomainR_out == "4" or DomainR_out == "5"


# ============================================================================
# 18.8.3.1 (L1) Ensure 'Include command line in process creation events' is ...
# ============================================================================
- name: "18.8.3.1 (L1) Ensure 'Include command line in process creation events'"
  include_tasks: win_check.yml
  vars:
   title: "The ProcessCreationIncludeCmdLine_Enabled setting (18.8.3.1)"
   check_against: "{{ ProcessCreationIncludeCmdLine_Enabled_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit"
     -name "ProcessCreationIncludeCmdLine_Enabled"|Select-Object
     -ExpandProperty "ProcessCreationIncludeCmdLine_Enabled"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit
    name: "ProcessCreationIncludeCmdLine_Enabled"
    data: "1"
    type: dword
  when: execute_18_8_3_1 == "YES"


# ============================================================================
# 18.8.4.1 (L1) Ensure 'Encryption Oracle Remediation' is set to 'Enabled:
# Force Updated Clients'
# ============================================================================
- name: "18.8.4.1 'Encryption Orcle Remediation'='Enabled: Force Updated Clnts'"
  include_tasks: win_check.yml
  vars:
   title: "The AllowEncryptionOracle setting (18.8.4.1)"
   check_against: "{{ AllowEncryptionOracle_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP\Parameters"
     -name "AllowEncryptionOracle"|Select-Object
     -ExpandProperty "AllowEncryptionOracle"
   win_regedit_cmd:
    path: "{{ Policies_reg }}System\\CredSSP\\Parameters"
    name: "AllowEncryptionOracle"
    data: "0"
    type: dword
  when: execute_18_8_4_1 == "YES"


# ============================================================================
# 18.8.4.2 (L1) Ensure 'Remote host allows delegation of non-exportable
# credentials' is set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.4.2 'Remte hst allws dlgtion of non-exportable creds'='Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The AllowProtectedCreds setting (18.8.4.2)"
   check_against: "{{ AllowProtectedCreds_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation"
     -name "AllowProtectedCreds"|Select-Object
     -ExpandProperty "AllowProtectedCreds"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation
    name: "AllowProtectedCreds"
    data: "1"
    type: dword
  when: execute_18_8_4_2 == "YES"


# ============================================================================
# 18.8.5.1 (NG) Ensure 'Turn On Virtualization Based Security' is set to
# 'Enabled' (Scored)
# ============================================================================
- name: "18.8.5.1 (NG) Ensure 'Turn On Virtualization Based Security'='Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The EnableVirtualizationBasedSecurity setting (18.8.5.1)"
   check_against: "{{ EnableVirtualizationBasedSecurity_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard"
     -name "EnableVirtualizationBasedSecurity"|Select-Object
     -ExpandProperty "EnableVirtualizationBasedSecurity"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: "EnableVirtualizationBasedSecurity"
    data: "1"
    type: dword
  when: execute_18_8_5_1 == "YES"


# ============================================================================
# 18.8.5.2 (NG) Ensure 'Turn On Virtualization Based Security: Select
# Platform Security Level' is set to 'Secure Boot and DMA Protection'
# ============================================================================
- name: "18.8.5.2 (NG) 'Turn On...... Level'='Secure Boot and DMA Protection'"
  include_tasks: win_check.yml
  vars:
   title: "The RequirePlatformSecurityFeatures setting (18.8.5.2)"
   check_against: "{{ RequirePlatformSecurityFeatures_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard"
     -name "RequirePlatformSecurityFeatures"|Select-Object
     -ExpandProperty "RequirePlatformSecurityFeatures"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: "RequirePlatformSecurityFeatures"
    data: "3"
    type: dword
  when: execute_18_8_5_2 == "YES"


# ============================================================================
# 18.8.5.3 (NG) Ensure 'Turn On Virtualization Based Security:
# Virtualization Based Protection of Code Integrity' is set to 'Enabled with
# UEFI lock' (Scored)
# ============================================================================
- name: "18.8.5.3 (NG) Ensure 'Turn On....Code Intgrty'='Enbled with UEFI lock'"
  include_tasks: win_check.yml
  vars:
   title: "The HypervisorEnforcedCodeIntegrity setting (18.8.5.3)"
   check_against: "{{ HypervisorEnforcedCodeIntegrity_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard"
     -name "HypervisorEnforcedCodeIntegrity"|Select-Object
     -ExpandProperty "HypervisorEnforcedCodeIntegrity"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: "HypervisorEnforcedCodeIntegrity"
    data: "2"
    type: dword
  when: execute_18_8_5_3 == "YES"


# ============================================================================
# 18.8.5.4 (NG) Ensure 'Turn On Virtualization Based Security: Require
# UEFI Memory Attributes Table' is set to 'True (checked)' (Scored)
# ============================================================================
- name: "18.8.5.4 (NG) Ensure 'Turn On Virtualization....able'='True (checked)'"
  include_tasks: win_check.yml
  vars:
   title: "The HVCIMATRequired setting (18.8.5.4)"
   check_against: "{{ HVCIMATRequired_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard"
     -name "HVCIMATRequired"|Select-Object
     -ExpandProperty "HVCIMATRequired"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: "HVCIMATRequired"
    data: "1"
    type: dword
  when: execute_18_8_5_4 == "YES"


# ============================================================================
# 18.8.5.5 (NG) Ensure 'Turn On Virtualization Based Security: Credential
# Guard Configuration' is set to 'Enabled with UEFI lock' (MS Only)
# (Scored)
# ============================================================================
- name: "18.8.5.5 (NG) Ensure 'Turn On...Config'='Enbled w\ UEFI lock'(MS Only)"
  include_tasks: win_check.yml
  vars:
   title: "The LsaCfgFlags setting (18.8.5.5)"
   check_against: "{{ LsaCfgFlags_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard"
     -name "LsaCfgFlags"|Select-Object
     -ExpandProperty "LsaCfgFlags"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: "LsaCfgFlags"
    data: "1"
    type: dword
  when: >
    execute_18_8_5_5 == "YES" and
    DomainR_out != "4" and
    DomainR_out != "5"


# ============================================================================
# 18.8.5.6 (NG) Ensure 'Turn On Virtualization Based Security: Credential
# Guard Configuration' is set to 'Disabled' (DC Only) (Scored)
# ============================================================================
- name: "18.8.5.6 (NG) Ensure 'Turn On......Guard Config'='Disabled' (DC Only)"
  include_tasks: win_check.yml
  vars:
   title: "The LsaCfgFlags setting (18.8.5.6)"
   check_against: "{{ LsaCfgFlagsDC_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard"
     -name "LsaCfgFlags"|Select-Object
     -ExpandProperty "LsaCfgFlags"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: "LsaCfgFlags"
    data: "0"
    type: dword
  when: >
    execute_18_8_5_6 == "YES" and (DomainR_out == "4" or DomainR_out == "5")


# ============================================================================
# 18.8.5.7 (NG) Ensure 'Turn On Virtualization Based Security: Secure
# Launch Configuration' is set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.5.7 (NG) 'Turn On Virt Based Security: Sec Lnch Config'='Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The ConfigureSystemGuardLaunch setting (18.8.5.7)"
   check_against: "{{ ConfigureSystemGuardLaunch_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard"
     -name "ConfigureSystemGuardLaunch"|Select-Object
     -ExpandProperty "ConfigureSystemGuardLaunch"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: "ConfigureSystemGuardLaunch"
    data: "1"
    type: dword
  when: >
    execute_18_8_5_7 == "YES"


# ============================================================================
# 18.8.14.1 (L1) Ensure 'Boot-Start Driver Initialization Policy' is set to..."
# ============================================================================
- name: "18.8.14.1 (L1) Ensure 'Boot-Start Driver Initialization Policy' is..."
  include_tasks: win_check.yml
  vars:
   title: "The DriverLoadPolicy setting (18.8.14.1)"
   check_against: "{{ DriverLoadPolicy_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SYSTEM\CurrentControlSet\Policies\EarlyLaunch"
     -name "DriverLoadPolicy"|Select-Object
     -ExpandProperty "DriverLoadPolicy"
   win_regedit_cmd:
    path: HKLM:\SYSTEM\CurrentControlSet\Policies\EarlyLaunch
    name: "DriverLoadPolicy"
    data: "3"
    type: dword
  when: execute_18_8_14_1 == "YES"


# =============================================================================
# 18.8.21.2 (L1) Ensure 'Configure registry policy processing: Do not apply...'
# =============================================================================
- name: "18.8.21.2 (L1) Ensure 'Configure registry policy processing: Do not..'"
  include_tasks: win_check.yml
  vars:
   title: "The NoBackgroundPolicy setting (18.8.21.2)"
   check_against: "{{ NoBackgroundPolicy_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\GroupPolicy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}"
     -name "NoBackgroundPolicy"|Select-Object
     -ExpandProperty "NoBackgroundPolicy"
   win_regedit_cmd:
    path: "{{ GroupPolicy_reg }}{35378EAC-683F-11D2-A89A-00C04FBBCFA2}"
    name: "NoBackgroundPolicy"
    data: "0"
    type: dword
  when: execute_18_8_21_2 == "YES"


# ============================================================================
# 18.8.21.3 (L1) Ensure 'Configure registry policy processing: Process even...'
# ============================================================================
- name: "18.8.21.3 (L1) Ensure 'Configure registry policy processing:...'"
  include_tasks: win_check.yml
  vars:
   title: "The NoGPOListChanges setting (18.8.21.3)"
   check_against: "{{ NoGPOListChanges_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\GroupPolicy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}"
     -name "NoGPOListChanges"|Select-Object -ExpandProperty "NoGPOListChanges"
   win_regedit_cmd:
    path: "{{ GroupPolicy_reg }}{35378EAC-683F-11D2-A89A-00C04FBBCFA2}"
    name: "NoGPOListChanges"
    data: "0"
    type: dword
  when: execute_18_8_21_3 == "YES"


# =============================================================================
# 18.8.21.4 (L1) 'Continue experiences on this device' is set to 'Disabled'
# =============================================================================
- name: "18.8.21.4 (L1) 'Continue experiences on this device' set to 'Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The EnableCdp setting (18.8.21.4)"
   check_against: "{{ EnableCdp_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
     -name "EnableCdp"|Select-Object -ExpandProperty "EnableCdp"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "EnableCdp"
    data: "0"
    type: dword
  when: execute_18_8_21_4 == "YES"


# =============================================================================
# 18.8.21.5 (L1) Ensure 'Turn off background refresh of Group Policy' is
# set to 'Disabled' (Scored)
# =============================================================================
- name: "18.8.21.5 (L1) 'Turn off bckgnd refresh of Grp Plcy' set to 'Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DisableBkGndGroupPolicy setting (18.8.21.5)"
   check_against: "{{ DisableBkGndGroupPolicy_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"
     -name "DisableBkGndGroupPolicy"|Select-Object
     -ExpandProperty "DisableBkGndGroupPolicy"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    name: "DisableBkGndGroupPolicy"
    data: "0"
    type: dword
  when: execute_18_8_21_5 == "YES"


# =============================================================================
# 18.8.22.1.1 (L2) Ensure 'Turn off downloading of print drivers over HTTP'
# is set to 'Enabled' (Scored)
# =============================================================================
- name: "18.8.21.1.1 (L2) 'Turn off dwnldng of prnt drvrs over HTTP'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DisableWebPnPDownload setting (18.8.21.1.1)"
   check_against: "{{ DisableWebPnPDownload_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows NT\Printers"
     -name "DisableWebPnPDownload"|Select-Object
     -ExpandProperty "DisableWebPnPDownload"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Printers
    name: "DisableWebPnPDownload"
    data: "1"
    type: dword
  when: execute_18_8_22_1_1 == "YES"


# ============================================================================
# 18.8.22.1.2 (L2) Ensure 'Turn off handwriting personalization data sharing'
# is set to 'Enabled'
# ============================================================================
- name: "18.8.22.1.2 (L2)'Turn off hndwrtng prsnlztn data sharing'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The PreventHandwritingDataSharing setting (18.8.22.1.2)"
   check_against: "{{ PreventHandwritingDataSharing_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\TabletPC"
     -name "PreventHandwritingDataSharing"|Select-Object
     -ExpandProperty "PreventHandwritingDataSharing"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\TabletPC
    name: "PreventHandwritingDataSharing"
    data: "1"
    type: dword
  when: execute_18_8_22_1_2 == "YES"


# =============================================================================
# 18.8.22.1.3 (L2) Ensure 'Turn off handwriting recognition error reporting'
# is set to 'Enabled' (Scored)
# =============================================================================
- name: "18.8.22.1.3 (L2)'Turn off hndwrtng rcgntn error reporting'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The PreventHandwritingErrorReports setting (18.8.22.1.3)"
   check_against: "{{ PreventHandwritingErrorReports_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows\HandwritingErrorReports"
     -name "PreventHandwritingErrorReports"|Select-Object
     -ExpandProperty "PreventHandwritingErrorReports"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows\HandwritingErrorReports
    name: "PreventHandwritingErrorReports"
    data: "1"
    type: dword
  when: execute_18_8_22_1_3 == "YES"


# =============================================================================
# 18.8.22.1.4 (L2) Ensure 'Turn off Internet Connection Wizard if URL
# connection is referring to Microsoft.com' is set to 'Enabled' (Scored)
# =============================================================================
- name: "18.8.22.1.4 (L2)'Turn off Internet Connection Wizard....' - 'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The ExitOnMSICW setting (18.8.22.1.4)"
   check_against: "{{ ExitOnMSICW_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows\Internet Connection Wizard"
     -name "ExitOnMSICW"|Select-Object -ExpandProperty "ExitOnMSICW"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows\Internet Connection Wizard
    name: "ExitOnMSICW"
    data: "1"
    type: dword
  when: execute_18_8_22_1_4 == "YES"


# ============================================================================
# 18.8.22.1.5 (L2) Ensure 'Turn off Internet download for Web publishing and
# online ordering wizards' is set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.22.1.5 (L2)'Turn off Internet..... ordering wizards'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The NoWebServices setting (18.8.22.1.5)"
   check_against: "{{ NoWebServices_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"
     -name "NoWebServices"|Select-Object -ExpandProperty "NoWebServices"
   win_regedit_cmd:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer
    name: "NoWebServices"
    data: "1"
    type: dword
  when: execute_18_8_22_1_5 == "YES"


# =============================================================================
# 18.8.22.1.6 (L2) Ensure 'Turn off printing over HTTP' is set to 'Enabled'
# =============================================================================
- name: "18.8.22.1.6 (L2) Ensure 'Turn off printing over HTTP' set to 'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DisableHTTPPrinting setting (18.8.22.1.6)"
   check_against: "{{ DisableHTTPPrinting_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows NT\Printers"
     -name "DisableHTTPPrinting"|Select-Object
     -ExpandProperty "DisableHTTPPrinting"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Printers
    name: "DisableHTTPPrinting"
    data: "1"
    type: dword
  when: execute_18_8_22_1_6 == "YES"


# =============================================================================
# 18.8.22.1.7 (L2) Ensure 'Turn off Registration if URL connection is
# referring to Microsoft.com' is set to 'Enabled' (Scored)
# =============================================================================
- name: "18.8.22.1.7 (L2) 'Turn off Registration if...Microsoft.com'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The NoRegistration setting (18.8.22.1.7)"
   check_against: "{{ NoRegistration_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows\Registration Wizard Control"
     -name "NoRegistration"|Select-Object -ExpandProperty "NoRegistration"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows\Registration Wizard Control
    name: "NoRegistration"
    data: "1"
    type: dword
  when: execute_18_8_22_1_7 == "YES"


# ============================================================================
# 18.8.22.1.8 (L2) Ensure 'Turn off Search Companion content file updates'
# is set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.22.1.8 (L2)'Turn off Srch Cmpnn content file updates'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DisableContentFileUpdates setting (18.8.22.1.8)"
   check_against: "{{ DisableContentFileUpdates_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\SearchCompanion"
     -name "DisableContentFileUpdates"|Select-Object
     -ExpandProperty "DisableContentFileUpdates"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\SearchCompanion
    name: "DisableContentFileUpdates"
    data: "1"
    type: dword
  when: execute_18_8_22_1_8 == "YES"


# ============================================================================
# 18.8.22.1.9 (L2) Ensure 'Turn off the "Order Prints" picture task' is
# set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.22.1.9 (L2) 'Turn off the 'Order Prints' picture task'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The NoOnlinePrintsWizard setting (18.8.22.1.9)"
   check_against: "{{ NoOnlinePrintsWizard_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"
     -name "NoOnlinePrintsWizard"|Select-Object
     -ExpandProperty "NoOnlinePrintsWizard"
   win_regedit_cmd:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer
    name: "NoOnlinePrintsWizard"
    data: "1"
    type: dword
  when: execute_18_8_22_1_9 == "YES"


# ============================================================================
# 18.8.22.1.10 (L2) Ensure 'Turn off the 'Publish to Web' task for files
# and folders' is set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.22.1.10 (L2) Ensure 'Turn off the...files and folders'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The NoPublishingWizard setting (18.8.22.1.10)"
   check_against: "{{ NoPublishingWizard_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"
     -name "NoPublishingWizard"|Select-Object
     -ExpandProperty "NoPublishingWizard"
   win_regedit_cmd:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer
    name: "NoPublishingWizard"
    data: "1"
    type: dword
  when: execute_18_8_22_1_10 == "YES"


# =============================================================================
# 18.8.22.1.11 (L2) Ensure 'Turn off the Windows Messenger Customer Experience
# Improvement Program' is set to 'Enabled' (Scored)
# =============================================================================
- name: "18.8.22.1.11 (L2) 'Turn off the...Improvement Program'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The CEIP setting (18.8.22.1.11)"
   check_against: "{{ CEIP_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Messenger\Client"
     -name "CEIP"|Select-Object -ExpandProperty "CEIP"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Messenger\Client
    name: "CEIP"
    data: "2"
    type: dword
  when: execute_18_8_22_1_11 == "YES"


# ============================================================================
# 18.8.22.1.12 (L2) Ensure 'Turn off Windows Customer Experience Improvement
# Program' is set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.22.1.12 (L2)'Turn off Windows....Improvement Program'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The CEIPEnable setting (18.8.22.1.12)"
   check_against: "{{ CEIPEnable_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\SQMClient\Windows"
     -name "CEIPEnable"|Select-Object -ExpandProperty "CEIPEnable"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\SQMClient\Windows
    name: "CEIPEnable"
    data: "0"
    type: dword
  when: execute_18_8_22_1_12 == "YES"


# ============================================================================
# 18.8.22.1.13 (L2) Ensure 'Turn off Windows Error Reporting' is set to
# 'Enabled' (Scored)
# ============================================================================
- name: "18.8.22.1.13 (L2)'Turn off Windows Error Reporting' set to 'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The Disabled setting (18.8.22.1.13)"
   check_against: "{{ Disabled_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows\Windows Error Reporting"
     -name "Disabled"|Select-Object -ExpandProperty "Disabled"
   win_regedit_cmd:
    path: "{{ windows_reg }}Windows Error Reporting"
    name: "Disabled"
    data: "1"
    type: dword
  when: execute_18_8_22_1_13 == "YES"

# ============================================================================
- name: "18.8.22.1.13 (L2)'Turn off Windows Error Reporting' set to 'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DoReport setting (18.8.22.1.13)"
   check_against: "{{ DoReport_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\PCHealth\ErrorReporting"
     -name "DoReport"|Select-Object -ExpandProperty "DoReport"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\PCHealth\ErrorReporting
    name: "DoReport"
    data: "0"
    type: dword
  when: execute_18_8_22_1_13 == "YES"


# ============================================================================
# 18.8.25.1 (L2) Ensure 'Support device authentication using certificate'
# is set to 'Enabled: Automatic' (Scored)
# ============================================================================
- name: "18.8.25.1 (L2) 'Support device auth using certificate'-'Enabled:Auto.'"
  include_tasks: win_check.yml
  vars:
   title: "The DevicePKInitBehavior setting (18.8.25.1)"
   check_against: "{{ DevicePKInitBehavior_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\kerberos\parameters"
     -name "DevicePKInitBehavior"|Select-Object
     -ExpandProperty "DevicePKInitBehavior"
   win_regedit_cmd:
    path: "{{ Policies_reg }}System\\kerberos\\parameters"
    name: "DevicePKInitBehavior"
    data: "0"
    type: dword
  when: execute_18_8_25_1 == "YES"


# ============================================================================
- name: "18.8.25.1 (L2) 'Support device auth using certificate'-'Enabled:Auto.'"
  include_tasks: win_check.yml
  vars:
   title: "The DevicePKInitEnabled setting (18.8.25.1)"
   check_against: "{{ DevicePKInitEnabled_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\kerberos\parameters"
     -name "DevicePKInitEnabled"|Select-Object
     -ExpandProperty "DevicePKInitEnabled"
   win_regedit_cmd:
    path: "{{ Policies_reg }}System\\kerberos\\parameters"
    name: "DevicePKInitEnabled"
    data: "1"
    type: dword
  when: execute_18_8_25_1 == "YES"


# ============================================================================
# 18.8.26.1 (L1) Ensure 'Enumeration policy for external devices
# incompatible with Kernel DMA Protection' is set to 'Enabled: Block All'
# (Scored)
# ============================================================================
- name: "18.8.26.1 (L1) Ensure 'Enumeration...DMA Protction'='Enbld: Block All'"
  include_tasks: win_check.yml
  vars:
   title: "The DeviceEnumerationPolicy setting (18.8.26.1)"
   check_against: "{{ DeviceEnumerationPolicy_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Kernel DMA Protection"
     -name "DeviceEnumerationPolicy"|Select-Object
     -ExpandProperty "DeviceEnumerationPolicy"
   win_regedit_cmd:
    path: "HKLM:\\SOFTWARE\Policies\\Microsoft\\Windows\\Kernel DMA Protection"
    name: "DeviceEnumerationPolicy"
    data: "0"
    type: dword
  when: execute_18_8_26_1 == "YES"


# ============================================================================
# 18.8.27.1 (L2) Ensure 'Disallow copying of user input methods to the system
# account for sign-in' is set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.27.1 (L2)'Disallow....system account for sign-in'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The BlockUserInputMethodsForSignIn setting (18.8.27.1)"
   check_against: "{{ BlockUserInputMethodsForSignIn_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Control Panel\International"
     -name "BlockUserInputMethodsForSignIn"|Select-Object
     -ExpandProperty "BlockUserInputMethodsForSignIn"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Control Panel\International
    name: "BlockUserInputMethodsForSignIn"
    data: "1"
    type: dword
  when: execute_18_8_27_1 == "YES"


# ============================================================================
# 18.8.28.1 (L1) Ensure 'Block user from showing account details on sign-in'
# is set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.28.1 (L1)'Block user from shwng acct details on sign-in'-Enabled"
  include_tasks: win_check.yml
  vars:
   title: "The BlockUserFromShowingAccountDetailsOnSignin setting (18.8.28.1)"
   check_against: "{{ BlckUsrFrmShwingAccntDetailsOnSignin_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows\System"
     -name "BlockUserFromShowingAccountDetailsOnSignin"|Select-Object
     -ExpandProperty "BlockUserFromShowingAccountDetailsOnSignin"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: "BlockUserFromShowingAccountDetailsOnSignin"
    data: "1"
    type: dword
  when: execute_18_8_28_1 == "YES"


# =============================================================================
# 18.8.28.2 (L1) Ensure 'Do not display network selection UI' is set to
# 'Enabled' (Scored)
# =============================================================================
- name: "18.8.28.2 (L1) Ensure 'Do not display network selection UI'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DontDisplayNetworkSelectionUI setting (18.8.28.2)"
   check_against: "{{ DontDisplayNetworkSelectionUI_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
     -name "DontDisplayNetworkSelectionUI"|Select-Object
     -ExpandProperty "DontDisplayNetworkSelectionUI"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "DontDisplayNetworkSelectionUI"
    data: "1"
    type: dword
  when: execute_18_8_28_2 == "YES"


# =============================================================================
# 18.8.28.3 (L1) Ensure 'Do not enumerate connected users on domain-joined
# computers' is set to 'Enabled' (Scored)
# =============================================================================
- name: "18.8.28.3 (L1) 'Do not enumerate....domain-joined computers'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DontEnumerateConnectedUsers setting (18.8.28.3)"
   check_against: "{{ DontEnumerateConnectedUsers_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
     -name "DontEnumerateConnectedUsers"|Select-Object
     -ExpandProperty "DontEnumerateConnectedUsers"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "DontEnumerateConnectedUsers"
    data: "1"
    type: dword
  when: execute_18_8_28_3 == "YES"


# =============================================================================
# 18.8.28.4 (L1) Ensure 'Enumerate local users on domain-joined computers' is
# set to 'Disabled' (Scored)
# =============================================================================
- name: "18.8.28.4 (L1)'Enumerate local usrs on domain-joined cmptrs'-Disabled"
  include_tasks: win_check.yml
  vars:
   title: "The EnumerateLocalUsers setting (18.8.28.4)"
   check_against: "{{ EnumerateLocalUsers_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
     -name "EnumerateLocalUsers"|Select-Object
     -ExpandProperty "EnumerateLocalUsers"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "EnumerateLocalUsers"
    data: "0"
    type: dword
  when: >
    execute_18_8_28_4 == "YES" and
    DomainR_out != "4" and
    DomainR_out != "5"


# ============================================================================
# 18.8.28.5 (L1) Ensure 'Turn off app notifications on the lock screen' is set
# to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.28.5 (L1)'Turn off app notifications on the lock screen'-Enabled"
  include_tasks: win_check.yml
  vars:
   title: "The DisableLockScreenAppNotifications setting (18.8.28.5)"
   check_against: "{{ DisableLockScreenAppNotifications_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
     -name "DisableLockScreenAppNotifications"|Select-Object
     -ExpandProperty "DisableLockScreenAppNotifications"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "DisableLockScreenAppNotifications"
    data: "1"
    type: dword
  when: execute_18_8_28_5 == "YES"


# ============================================================================
# 18.8.28.6 (L1) Ensure 'Turn off picture password sign-in' is set to
# 'Enabled' (Scored)
# ============================================================================
- name: "18.8.28.6 (L1) Ensure 'Turn off picture password sign-in'='Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DisableLockScreenAppNotifications setting (18.8.28.6)"
   check_against: "{{ BlockDomainPicturePassword_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
     -name "BlockDomainPicturePassword"|Select-Object
     -ExpandProperty "BlockDomainPicturePassword"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "BlockDomainPicturePassword"
    data: "1"
    type: dword
  when: execute_18_8_28_6 == "YES"


# ============================================================================
# 18.8.28.7 (L1) Ensure 'Turn on convenience PIN sign-in' is set to 'Disabled'
# ============================================================================
- name: "18.8.28.7 (L1) 'Turn on convenience PIN sign-in' is set to 'Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The AllowDomainPINLogon setting (18.8.28.7)"
   check_against: "{{ AllowDomainPINLogon_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
     -name "AllowDomainPINLogon"|Select-Object
     -ExpandProperty "AllowDomainPINLogon"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "AllowDomainPINLogon"
    data: "0"
    type: dword
  when: execute_18_8_28_7 == "YES"


# =============================================================================
# 18.8.31.1 (L2) Ensure 'Allow Clipboard synchronization across devices' is
# set to 'Disabled' (Scored)
# =============================================================================
- name: "18.8.31.1 (L2) Ensure 'Allw Clpbrd synch across devices'='Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The AllowCrossDeviceClipboard setting (18.8.31.1)"
   check_against: "{{ AllowCrossDeviceClipboard_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
     -name "AllowCrossDeviceClipboard"|Select-Object
     -ExpandProperty "AllowCrossDeviceClipboard"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "AllowCrossDeviceClipboard"
    data: "0"
    type: dword
  when: execute_18_8_31_1 == "YES"


# =============================================================================
# 18.8.31.2 (L2) Ensure 'Allow upload of User Activities' is set to 'Disabled'
# =============================================================================
- name: "18.8.31.2 (L2) Ensure 'Allow upload of User Activities' = 'Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The UploadUserActivities setting (18.8.31.2)"
   check_against: "{{ UploadUserActivities_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Windows\System"
     -name "UploadUserActivities"|Select-Object
     -ExpandProperty "UploadUserActivities"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "UploadUserActivities"
    data: "0"
    type: dword
  when: execute_18_8_31_2 == "YES"


# =============================================================================
# 18.8.34.6.1 (L2) Ensure 'Allow network connectivity during connected-standby
# (on battery)' is set to 'Disabled' (Scored)
# =============================================================================
- name: "18.8.34.6.1 (L2)'Allow.....connected-standby (on battery)'='Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DCSettingIndex setting (18.8.34.6.1)"
   check_against: "{{ DCSettingIndex_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\f15576e8-98b7-4186-b944-eafa664402d9"
     -name "DCSettingIndex"|Select-Object -ExpandProperty "DCSettingIndex"
   win_regedit_cmd:
    path: "{{ Powersetting_reg }}f15576e8-98b7-4186-b944-eafa664402d9"
    name: "DCSettingIndex"
    data: "0"
    type: dword
  when: execute_18_8_34_6_1 == "YES"


# ============================================================================
# 18.8.34.6.2 (L2) Ensure 'Allow network connectivity during connected-standby
# (plugged in)' is set to 'Disabled' (Scored)
# ============================================================================
- name: "18.8.34.6.2 (L2)'Allow network.......(plugged in)'-'Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The ACSettingIndex setting (18.8.34.6.2)"
   check_against: "{{ ACSettingIndex_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\f15576e8-98b7-4186-b944-eafa664402d9"
     -name "ACSettingIndex"|Select-Object -ExpandProperty "ACSettingIndex"
   win_regedit_cmd:
    path: "{{ Powersetting_reg }}f15576e8-98b7-4186-b944-eafa664402d9"
    name: "ACSettingIndex"
    data: "0"
    type: dword
  when: execute_18_8_34_6_2 == "YES"


# ============================================================================
# 18.8.34.6.3 (L2) Ensure 'Require a password when a computer wakes
# (on battery)' is set to 'Enabled' (Scored)
# ============================================================================
- name: "18.8.34.6.3 (L2) 'Require a password.....wakes (on battery)'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DCSettingIndex setting (18.8.34.6.3)"
   check_against: "{{ DCSettingIndex2_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51"
     -name "DCSettingIndex"|Select-Object -ExpandProperty "DCSettingIndex"
   win_regedit_cmd:
    path: "{{ Powersetting_reg }}0e796bdb-100d-47d6-a2d5-f7d2daa51f51"
    name: "DCSettingIndex"
    data: "1"
    type: dword
  when: execute_18_8_34_6_3 == "YES"


# =============================================================================
# 18.8.34.6.4 (L2) Ensure 'Require a password when a computer wakes
# (plugged in)' is set to 'Enabled' (Scored)
# =============================================================================
- name: "18.8.34.6.4 (L2)'Require a password when a computer wakes..'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The ACSettingIndex setting (18.8.34.6.4)"
   check_against: "{{ ACSettingIndex2_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51"
     -name "ACSettingIndex"|Select-Object -ExpandProperty "ACSettingIndex"
   win_regedit_cmd:
    path: "{{ Powersetting_reg }}0e796bdb-100d-47d6-a2d5-f7d2daa51f51"
    name: "ACSettingIndex"
    data: "1"
    type: dword
  when: execute_18_8_34_6_4 == "YES"


# =============================================================================
# 18.8.36.1 (L1) Ensure 'Configure Offer Remote Assistance' is set to 'Disabled'
# =============================================================================
- name: "18.8.36.1 (L1) Ensure 'Configure Offer Remote Assistance'-'Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The fAllowUnsolicited setting (18.8.36.1)"
   check_against: "{{ fAllowUnsolicited_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services"
     -name "fAllowUnsolicited"|Select-Object -ExpandProperty "fAllowUnsolicited"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
    name: "fAllowUnsolicited"
    data: "0"
    type: dword
  when: execute_18_8_36_1 == "YES"


# =============================================================================
# 18.8.36.2 (L1)  'Configure Solicited Remote Assistance' is set to 'Disabled'
# =============================================================================
- name: "18.8.36.2 (L1) 'Configure Solicited Remote Assistance'-'Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The fAllowToGetHelp setting (18.8.36.2)"
   check_against: "{{ fAllowToGetHelp_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services"
     -name "fAllowToGetHelp"|Select-Object -ExpandProperty "fAllowToGetHelp"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
    name: "fAllowToGetHelp"
    data: "0"
    type: dword
  when: execute_18_8_36_2 == "YES"


# =============================================================================
# 18.8.37.1 (L1) Ensure 'Enable RPC Endpoint Mapper Client Authentication' is
#  set to 'Enabled' (MS only)
# =============================================================================
- name: "18.8.37.1 (L1)'Enable RPC Endpnt Mppr Client Authentication'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The EnableAuthEpResolution setting (18.8.37.1)"
   check_against: "{{ EnableAuthEpResolution_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\Software\Policies\Microsoft\Windows NT\Rpc"
     -name "EnableAuthEpResolution"|Select-Object
     -ExpandProperty "EnableAuthEpResolution"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Rpc
    name: "EnableAuthEpResolution"
    data: "1"
    type: dword
  when: >
    execute_18_8_37_1 == "YES" and
    DomainR_out != "4" and
    DomainR_out != "5"


# ============================================================================
# 18.8.37.2 (L2) Ensure 'Restrict Unauthenticated RPC clients' is set to
# 'Enabled: Authenticated' (MS only) (Scored)
# ============================================================================
- name: "18.8.37.2 (L2)'Restrict Unauthenticated RPC clients'-'Enabled:Auth'"
  include_tasks: win_check.yml
  vars:
   title: "The RestrictRemoteClients setting (18.8.37.2)"
   check_against: "{{ RestrictRemoteClients_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path "HKLM:\Software\Policies\Microsoft\Windows NT\Rpc"
     -name "RestrictRemoteClients"|Select-Object
     -ExpandProperty "RestrictRemoteClients"
   win_regedit_cmd:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Rpc
    name: "RestrictRemoteClients"
    data: "1"
    type: dword
  when: >
    execute_18_8_37_2 == "YES" and
    DomainR_out != "4" and
    DomainR_out != "5"


# =============================================================================
# 18.8.45.5.1 (L2) Ensure 'Microsoft Support Diagnostic Tool: Turn on MSDT
# interactive communication with support provider' is set to 'Disabled' (Scored)
# =============================================================================
- name: "18.8.45.5.1 (L2)'Microsoft Support Diagnostic....provider'-'Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DisableQueryRemoteServer setting (18.8.45.5.1)"
   check_against: "{{ DisableQueryRemoteServer_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows\ScriptedDiagnosticsProvider\Policy"
     -name "DisableQueryRemoteServer"|Select-Object
     -ExpandProperty "DisableQueryRemoteServer"
   win_regedit_cmd:
    path: "{{ windows_reg }}ScriptedDiagnosticsProvider\\Policy"
    name: "DisableQueryRemoteServer"
    data: "0"
    type: dword
  when: execute_18_8_45_5_1 == "YES"


# =============================================================================
# 18.8.45.11.1 (L2) Ensure 'Enable/Disable PerfTrack' is set to 'Disabled'
# =============================================================================
- name: "18.8.45.11.1 (L2) 'Enable/Disable PerfTrack' is set to 'Disabled'"
  include_tasks: win_check.yml
  vars:
   title: "The ScenarioExecutionEnabled setting (18.8.45.11.1)"
   check_against: "{{ ScenarioExecutionEnabled_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\Software\Policies\Microsoft\Windows\WDI\{9c5a40da-b965-4fc3-8781-88dd50a6299d}"
     -name "ScenarioExecutionEnabled"|Select-Object
     -ExpandProperty "ScenarioExecutionEnabled"
   win_regedit_cmd:
    path: "{{ windows_reg }}WDI\\{9c5a40da-b965-4fc3-8781-88dd50a6299d}"
    name: "ScenarioExecutionEnabled"
    data: "0"
    type: dword
  when: execute_18_8_45_11_1 == "YES"


# =============================================================================
# 18.8.47.1 (L2) Ensure 'Turn off the advertising ID' is set to 'Enabled'
# =============================================================================
- name: "18.8.47.1 (L2) 'Turn off the advertising ID' is set to 'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The DisabledByGroupPolicy setting (18.8.47.1)"
   check_against: "{{ DisabledByGroupPolicy_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\policies\Microsoft\Windows\AdvertisingInfo"
     -name "DisabledByGroupPolicy"|Select-Object
     -ExpandProperty "DisabledByGroupPolicy"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\policies\Microsoft\Windows\AdvertisingInfo
    name: "DisabledByGroupPolicy"
    data: "1"
    type: dword
  when: execute_18_8_47_1 == "YES"


# =============================================================================
# 18.8.50.1.1 (L2) Ensure 'Enable Windows NTP Client' is set to 'Enabled'
# =============================================================================
- name: "18.8.50.1.1 (L2) Ensure 'Enable Windows NTP Client' set to 'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The Enabled setting (18.8.50.1.1)"
   check_against: "{{ Enabled_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\System\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient"
     -name "Enabled"|Select-Object -ExpandProperty "Enabled"
   win_regedit_cmd:
    path: "{{ tp_reg }}NtpClient"
    name: "Enabled"
    data: "1"
    type: dword
  when: execute_18_8_50_1_1 == "YES"


# =============================================================================
# 18.8.50.1.2 (L2) 'Enable Windows NTP Server' is set to 'Disabled' (MS only)
# =============================================================================
- name: "18.8.50.1.2 (L2)'Enable Windows NTP Server' set 'Disabled' (MS only)"
  include_tasks: win_check.yml
  vars:
   title: "The Enabled setting (18.8.50.1.2)"
   check_against: "{{ Enabled2_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKLM:\SOFTWARE\Policies\Microsoft\W32Time\TimeProviders\NtpServer"
     -name "Enabled"|Select-Object -ExpandProperty "Enabled"
   win_regedit_cmd:
    path: HKLM:\SOFTWARE\Policies\Microsoft\W32Time\TimeProviders\NtpServer
    name: "Enabled"
    data: "0"
    type: dword
  when: execute_18_8_50_1_2 == "YES"


# ============================================================================
# 19.6.6.1.1 (L2)'Turn off Help Experience Improvement Program' set to 'Enabled'
# =============================================================================
- name: "19.6.6.1.1 (L2)'Turn off Help Exprnc Improvement Program'-'Enabled'"
  include_tasks: win_check.yml
  vars:
   title: "The NoImplicitFeedback setting (19.6.6.1.1)"
   check_against: "{{ NoImplicitFeedback_cis }}"
   win_shell_cmd: >
     Get-ItemProperty -path
     "HKCU:\Software\Policies\Microsoft\Assistance\Client\1.0"
     -name "NoImplicitFeedback"|Select-Object
     -ExpandProperty "NoImplicitFeedback"
   win_regedit_cmd:
    path: 'HKCU:\Software\Policies\Microsoft\Assistance\Client\1.0'
    name: "NoImplicitFeedback"
    data: "1"
    type: dword
  when: execute_19_6_6_1_1 == "YES"
